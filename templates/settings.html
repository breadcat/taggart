{{template "_header" .}}
<h1>Settings</h1>

{{if .Data.Error}}
<div style="background-color: #f8d7da; color: #721c24; padding: 10px; border: 1px solid #f5c6cb; border-radius: 4px; margin-bottom: 20px;">
    <strong>Error:</strong> {{.Data.Error}}
</div>
{{end}}

{{if .Data.Success}}
<div style="background-color: #d4edda; color: #155724; padding: 10px; border: 1px solid #c3e6cb; border-radius: 4px; margin-bottom: 20px;">
    <strong>Success:</strong> {{.Data.Success}}
</div>
{{end}}

<form method="post" style="max-width: 600px;">
    <div style="margin-bottom: 20px;">
        <label for="database_path" style="display: block; font-weight: bold; margin-bottom: 5px;">Database Path:</label>
        <input type="text" id="database_path" name="database_path" value="{{.Data.Config.DatabasePath}}" required
               style="width: 100%; padding: 8px; font-size: 14px;"
               placeholder="./database.db">
        <small style="color: #666;">Path to SQLite database file (requires restart if changed)</small>
    </div>

    <div style="margin-bottom: 20px;">
        <label for="upload_dir" style="display: block; font-weight: bold; margin-bottom: 5px;">Upload Directory:</label>
        <input type="text" id="upload_dir" name="upload_dir" value="{{.Data.Config.UploadDir}}" required
               style="width: 100%; padding: 8px; font-size: 14px;"
               placeholder="uploads">
        <small style="color: #666;">Directory where uploaded files are stored</small>
    </div>

    <div style="margin-bottom: 20px;">
        <label for="server_port" style="display: block; font-weight: bold; margin-bottom: 5px;">Server Port:</label>
        <input type="text" id="server_port" name="server_port" value="{{.Data.Config.ServerPort}}" required
               style="width: 100%; padding: 8px; font-size: 14px;"
               placeholder=":8080">
        <small style="color: #666;">Port for web server (format: :8080, requires restart if changed)</small>
    </div>

    <div style="margin-bottom: 20px;">
        <label for="instance_name" style="display: block; font-weight: bold; margin-bottom: 5px;">Instance Name:</label>
        <input type="text" id="instance_name" name="instance_name" value="{{.Data.Config.InstanceName}}" required
               style="width: 100%; padding: 8px; font-size: 14px;"
               placeholder="Taggart">
        <small style="color: #666;">Instance Name, used in header and title bar</small>
    </div>

    <div style="margin-bottom: 20px;">
        <label for="gallery_size" style="display: block; font-weight: bold; margin-bottom: 5px;">Gallery Size:</label>
        <input type="text" id="gallery_size" name="gallery_size" value="{{.Data.Config.GallerySize}}" required
               style="width: 100%; padding: 8px; font-size: 14px;"
               placeholder="400px">
        <small style="color: #666;">Size of previews used in galleries</small>
    </div>

    <div style="margin-bottom: 20px;">
        <label for="items_per_page" style="display: block; font-weight: bold; margin-bottom: 5px;">Items per Page:</label>
        <input type="text" id="items_per_page" name="items_per_page" value="{{.Data.Config.ItemsPerPage}}" required
               style="width: 100%; padding: 8px; font-size: 14px;"
               placeholder="100">
        <small style="color: #666;">Items per page in galleries</small>
    </div>

    <button type="submit" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
        Save Settings
    </button>
</form>

<hr style="margin: 40px 0;">

<h2>Tag Aliases</h2>
<p style="color: #666; margin-bottom: 20px;">
    Define tag aliases so that multiple tag values are treated as equivalent when searching or filtering. 
    For example, if you alias "colour/blue" with "colour/navy", searching for either will show files tagged with both.
</p>

<div id="aliases-section" style="max-width: 800px;">
    <div id="alias-groups"></div>
    
    <button onclick="addAliasGroup()" style="background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; margin-top: 10px;">
        + Add Alias Group
    </button>
    
    <form method="post" id="aliases-form" style="margin-top: 20px;">
        <input type="hidden" name="action" value="save_aliases">
        <input type="hidden" name="aliases_json" id="aliases_json">
        <button type="submit" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
            Save Aliases
        </button>
    </form>
</div>

<script>
let aliasGroups = {{.Data.Config.TagAliases}};
if (!aliasGroups) {
    aliasGroups = [];
}

function renderAliasGroups() {
    const container = document.getElementById('alias-groups');
    container.innerHTML = '';
    
    aliasGroups.forEach((group, groupIndex) => {
        const groupDiv = document.createElement('div');
        groupDiv.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 4px; background-color: #f8f9fa;';
        
        groupDiv.innerHTML = `
            <div style="margin-bottom: 10px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Category:</label>
                <input type="text" 
                       value="${escapeHtml(group.category)}" 
                       onchange="updateCategory(${groupIndex}, this.value)"
                       style="width: 200px; padding: 6px; font-size: 14px;"
                       placeholder="e.g., colour">
            </div>
            
            <div style="margin-bottom: 10px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Aliased Values:</label>
                <div id="aliases-${groupIndex}"></div>
                <button onclick="addAlias(${groupIndex})" type="button" style="background-color: #17a2b8; color: white; padding: 4px 12px; border: none; border-radius: 3px; font-size: 13px; cursor: pointer; margin-top: 5px;">
                    + Add Value
                </button>
            </div>
            
            <button onclick="removeAliasGroup(${groupIndex})" type="button" style="background-color: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 3px; font-size: 13px; cursor: pointer;">
                Remove Group
            </button>
        `;
        
        container.appendChild(groupDiv);
        renderAliases(groupIndex);
    });
}

function renderAliases(groupIndex) {
    const container = document.getElementById(`aliases-${groupIndex}`);
    container.innerHTML = '';
    
    const group = aliasGroups[groupIndex];
    if (!group.aliases) {
        group.aliases = [];
    }
    
    group.aliases.forEach((alias, aliasIndex) => {
        const aliasDiv = document.createElement('div');
        aliasDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 5px; align-items: center;';
        
        aliasDiv.innerHTML = `
            <input type="text" 
                   value="${escapeHtml(alias)}" 
                   onchange="updateAlias(${groupIndex}, ${aliasIndex}, this.value)"
                   style="flex: 1; padding: 6px; font-size: 14px;"
                   placeholder="e.g., blue">
            <button onclick="removeAlias(${groupIndex}, ${aliasIndex})" type="button" style="background-color: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 3px; font-size: 12px; cursor: pointer;">
                Remove
            </button>
        `;
        
        container.appendChild(aliasDiv);
    });
}

function addAliasGroup() {
    aliasGroups.push({
        category: '',
        aliases: ['', '']
    });
    renderAliasGroups();
}

function removeAliasGroup(groupIndex) {
    if (confirm('Remove this alias group?')) {
        aliasGroups.splice(groupIndex, 1);
        renderAliasGroups();
    }
}

function updateCategory(groupIndex, value) {
    aliasGroups[groupIndex].category = value;
}

function addAlias(groupIndex) {
    aliasGroups[groupIndex].aliases.push('');
    renderAliases(groupIndex);
}

function removeAlias(groupIndex, aliasIndex) {
    aliasGroups[groupIndex].aliases.splice(aliasIndex, 1);
    renderAliases(groupIndex);
}

function updateAlias(groupIndex, aliasIndex, value) {
    aliasGroups[groupIndex].aliases[aliasIndex] = value;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

document.getElementById('aliases-form').addEventListener('submit', function(e) {
    // Filter out empty groups and aliases
    const cleanedGroups = aliasGroups
        .filter(group => group.category && group.aliases && group.aliases.length > 0)
        .map(group => ({
            category: group.category.trim(),
            aliases: group.aliases.filter(a => a && a.trim()).map(a => a.trim())
        }))
        .filter(group => group.aliases.length >= 2); // Need at least 2 values to be an alias
    
    document.getElementById('aliases_json').value = JSON.stringify(cleanedGroups);
});

// Initial render
renderAliasGroups();
</script>

<div style="margin-top: 40px; padding: 20px; background-color: #f8f9fa; border-radius: 5px;">
    <h3>Current Configuration:</h3>
    <ul>
        <li><strong>Database:</strong> {{.Data.Config.DatabasePath}}</li>
        <li><strong>Upload Directory:</strong> {{.Data.Config.UploadDir}}</li>
        <li><strong>Server Port:</strong> {{.Data.Config.ServerPort}}</li>
        <li><strong>Instance Name:</strong> {{.Data.Config.InstanceName}}</li>
        <li><strong>Gallery Size:</strong> {{.Data.Config.GallerySize}}</li>
        <li><strong>Items per Page:</strong> {{.Data.Config.ItemsPerPage}}</li>
    </ul>

    <h4>Configuration File:</h4>
    <p>Settings are stored in <code>config.json</code> in the application directory.</p>
</div>

<hr style="margin: 40px 0;">

<h2>Database Maintenance</h2>

<form method="post" style="margin-bottom: 20px;">
    <input type="hidden" name="action" value="backup">
    <button type="submit" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
        Backup Database
    </button>
    <small style="color: #666; margin-left: 10px;">Creates a timestamped backup of the database file</small>
</form>

<form method="post">
    <input type="hidden" name="action" value="vacuum">
    <button type="submit" style="background-color: #6f42c1; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
        Vacuum Database
    </button>
    <small style="color: #666; margin-left: 10px;">Reclaims unused space and optimizes database performance</small>
</form>

{{template "_footer"}}
